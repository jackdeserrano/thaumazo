\ProvidesPackage{thaumazo}


%%options


\newif\ifcourse\coursefalse
\newif\ifplain\plainfalse
\newif\ifassg\assgfalse
\newif\ifams\amsfalse
\newif\ifindex\indexfalse
\newif\iftitlesamepage\titlesamepagefalse
\newif\ifsections\sectionstrue
\newif\ifupdatedate\updatedatetrue
\newif\ifuprighttheorem\uprighttheoremfalse
\newif\ifaug\augtrue
\newif\ifold\oldfalse


\DeclareOption{course}{\coursetrue}%does nothing
\DeclareOption{plain}{\plaintrue}
\DeclareOption{assg}{\assgtrue}
\DeclareOption{ams}{\amstrue}
\DeclareOption{index}{\indextrue}
\DeclareOption{titlesamepage}{\titlesamepagetrue}
\DeclareOption{nosections}{\sectionsfalse}
\DeclareOption{noupdatedate}{\updatedatefalse}
\DeclareOption{uprighttheorem}{\uprighttheoremtrue}
\DeclareOption{noaug}{\augfalse}
\DeclareOption{old}{\oldtrue}


\ProcessOptions\relax


%%


\RequirePackage{tipa}
%
\RequirePackage[usenames,svgnames,dvipsnames]{xcolor}
%
\RequirePackage{amsthm,amssymb,amsfonts}
\RequirePackage[leqno]{amsmath}
%
\RequirePackage{microtype}
%
\RequirePackage{enumitem}
%
\RequirePackage{graphicx}
%
\RequirePackage{parcolumns}
%
\RequirePackage{tikz}
\RequirePackage{tikz-cd}
\usetikzlibrary{trees,backgrounds,decorations.text,calc}
\tikzcdset{
  arrow style=tikz,
  diagrams={>={Classical TikZ Rightarrow[]}}
}
%
\RequirePackage[usestackEOL]{stackengine}
%
\RequirePackage[T1]{fontenc}
%
\RequirePackage[utf8x]{inputenc}
%
\RequirePackage[scaled]{beramono}
%
\RequirePackage{regexpatch}
%
\RequirePackage{fancyhdr}
\setlength{\headheight}{15pt}
%
\RequirePackage{mathrsfs}
\DeclareMathAlphabet{\mathcal}{OMS}{cmsy}{m}{n}
%
\RequirePackage{imakeidx}
%
\RequirePackage[colorlinks,linkcolor=Black,citecolor=Black,urlcolor=Black]{hyperref}
%
\RequirePackage{cleveref}
\crefname{equation}{}{}
%
\RequirePackage{geometry}
\ifold
\geometry{left=1.5in,bottom=1.5in,right=1.5in,top=1.5in,inner=1.5in,outer=1.5in}
\else
\geometry{left=1in,bottom=1.5in,right=1in,top=1.5in,inner=1.5in,outer=1.5in}
\fi
%
\RequirePackage{booktabs}
%


%%commands


%groups
\newcommand{\Alt}{\mathfrak A}
\newcommand{\Cyc}{\mathfrak C}
\newcommand{\Di}{\mathfrak D}
\newcommand{\Sy}{\mathfrak S}

%\mathfrak
\newcommand{\hh}{\mathfrak H}
\newcommand{\dd}{\mathfrak d}
\newcommand{\mm}{\mathfrak m}
\newcommand{\MM}{\mathfrak M}
\newcommand{\oo}{\mathfrak o}
\newcommand{\pp}{\mathfrak p}
\newcommand{\PP}{\mathfrak P}
\newcommand{\XX}{\mathfrak X}
\newcommand{\YY}{\mathfrak Y}
\newcommand{\Zf}{\mathfrak Z}
\newcommand{\Bor}{\mathfrak{Bor}}

%\mathbf
\newcommand{\C}{\mathbf C}
\newcommand{\F}{\mathbf F}
%\let\H\relax
%\newcommand{\H}{\mathbf H}
\newcommand{\K}{\mathbf K}
\newcommand{\N}{\mathbf N}
\let\P\relax
\newcommand{\P}{\mathbf P}
\newcommand{\Q}{\mathbf Q}
\newcommand{\R}{\mathbf R}
\newcommand{\T}{\mathbf T}
\newcommand{\Z}{\mathbf Z}

%\mathscr
\newcommand{\Fs}{\mathscr F}
\newcommand{\Ms}{\mathscr M}

%misc.
\newcommand{\adj}{\rightleftharpoons}
\newcommand{\eps}{\varepsilon}
\newcommand{\etco}{H\sub{\'et}}
\newcommand{\inv}{^{-1}}
\newcommand{\isomto}{\cong}
\newcommand{\ol}{\overline}
\newcommand{\powerset}{\PP}
\newcommand{\Simp}{\text{{\sc Simp}}}
\DeclareMathOperator*{\tensor}{\otimes}
\newcommand{\sub}[1]{_{\textup {#1}}}
\let\super\relax
\newcommand{\super}[1]{^{\textup {#1}}}
\newcommand{\Trig}{\text{{\sc Trig}}}
\newcommand{\Gset}{G\operatorname{-set}}
\newcommand{\Gpfset}{G\operatorname{-pfset}}
\newcommand{\kCondSet}[1]{#1\operatorname{-CondSet}}
\newcommand{\from}{\leftarrow}
\newcommand{\inhom}{\underline{\Hom}}
\newcommand{\abs}[1]{\left\lvert #1 \right\rvert}
\newcommand{\norm}[1]{\left\lVert #1 \right\rVert}
\newcommand{\nnorm}{\norm{\,\cdot\,}}
\newcommand{\du}[1]{\underline{\underline{#1}}}


%%``operators''


%limits
\DeclareMathOperator*{\argmax}{arg\ max}
\DeclareMathOperator*{\argmin}{arg\ min}
\DeclareMathOperator*{\colim}{colim}
\DeclareMathOperator*{\esssup}{ess\ sup}
\DeclareMathOperator*{\lcm}{lcm}
\DeclareMathOperator*{\sotlim}{\textsc{sot}-lim}
\DeclareMathOperator*{\wotlim}{\textsc{wot}-lim}
\DeclareMathOperator*{\wtlim}{\textsc{w}-lim}
\DeclareMathOperator*{\wstlim}{\ensuremath{\textsc{w}^\ast}-lim}

%no limits
\DeclareMathOperator{\agm}{agm}
\DeclareMathOperator{\Ani}{Ani}
\DeclareMathOperator{\Ass}{Ass}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\Ann}{Ann}
\DeclareMathOperator{\bd}{bd}
\DeclareMathOperator{\Br}{Br}
\DeclareMathOperator{\Bun}{Bun}
\DeclareMathOperator{\Burn}{Burn}
\DeclareMathOperator{\CaCl}{CaCl}
\DeclareMathOperator{\card}{card}
\DeclareMathOperator{\Cat}{Cat}
\DeclareMathOperator{\chr}{char}
\DeclareMathOperator{\Cl}{Cl}
\DeclareMathOperator{\cl}{cl}
\DeclareMathOperator{\codim}{codim}
\DeclareMathOperator{\Coker}{Coker}
\DeclareMathOperator{\coker}{coker}
\DeclareMathOperator{\Coim}{Coim}
\DeclareMathOperator{\coim}{coim}
\DeclareMathOperator{\Col}{Col}
\DeclareMathOperator{\Cov}{Cov}
\DeclareMathOperator{\csch}{csch}
\DeclareMathOperator{\curl}{curl}
\DeclareMathOperator{\Dem}{Dem}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\Disc}{Disc}
\DeclareMathOperator{\dist}{dist}
\DeclareMathOperator{\Div}{Div}
\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\Dom}{Dom}
\DeclareMathOperator{\End}{End}
\DeclareMathOperator{\error}{error}
\DeclareMathOperator{\ev}{ev}
\DeclareMathOperator{\Et}{\acute Et}
\DeclareMathOperator{\Exc}{Exc}
\DeclareMathOperator{\ext}{ext}
\DeclareMathOperator{\Ext}{Ext}
\DeclareMathOperator{\Fil}{Fil}
\DeclareMathOperator{\Fix}{Fix}
\DeclareMathOperator{\forget}{forget}
\DeclareMathOperator{\free}{free}
\DeclareMathOperator{\Free}{Free}
\DeclareMathOperator{\Frac}{Frac}
\DeclareMathOperator{\Frob}{Frob}
\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\GKdim}{GKdim}
\DeclareMathOperator{\GL}{GL}
\DeclareMathOperator{\Gr}{Gr}
\DeclareMathOperator{\Hck}{Hck}
\DeclareMathOperator{\Hess}{Hess}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Hilb}{Hilb}
\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\img}{im}
\DeclareMathOperator{\Img}{Im}
\DeclareMathOperator{\Image}{Image}
\DeclareMathOperator{\Ind}{Ind}
\DeclareMathOperator{\ind}{ind}
\DeclareMathOperator{\Inn}{Inn}
\DeclareMathOperator{\Int}{Int}
\DeclareMathOperator{\inr}{int}
\DeclareMathOperator{\ISO}{ISO}
\DeclareMathOperator{\Jac}{Jac}
\DeclareMathOperator{\Kdim}{Kdim}
\let\Ker\relax
\DeclareMathOperator{\Ker}{Ker}
\DeclareMathOperator{\Length}{Length}
\DeclareMathOperator{\Loc}{Loc}
\DeclareMathOperator{\Log}{Log}
\DeclareMathOperator{\Mat}{Mat}
\DeclareMathOperator{\mesh}{mesh}
\DeclareMathOperator{\Mor}{Mor}
\DeclareMathOperator{\Mp}{Mp}
\DeclareMathOperator{\MSpec}{MSpec}
\DeclareMathOperator{\mult}{mult}
\DeclareMathOperator{\Nil}{Nil}
\DeclareMathOperator{\NL}{NL}
\DeclareMathOperator{\Null}{Null}
\DeclareMathOperator{\orb}{orb}
\DeclareMathOperator{\ord}{ord}
\DeclareMathOperator{\Ob}{Ob}
\DeclareMathOperator{\On}{On}
\DeclareMathOperator{\Out}{Out}
\DeclareMathOperator{\Perf}{Perf}
\DeclareMathOperator{\prp}{perp}
\DeclareMathOperator{\Perv}{Perv}
\DeclareMathOperator{\Pic}{Pic}
\DeclareMathOperator{\pred}{pred}
\DeclareMathOperator{\pr}{pr}
\let\Pr\relax
\DeclareMathOperator{\Pr}{Pr}
\DeclareMathOperator{\Proj}{Proj}
\DeclareMathOperator{\proj}{proj}
\DeclareMathOperator{\PGL}{PGL}
\DeclareMathOperator{\PSL}{PSL}
\DeclareMathOperator{\rad}{rad}
\DeclareMathOperator{\Ran}{Ran}
\DeclareMathOperator{\ran}{ran}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\rec}{rec}
\DeclareMathOperator{\red}{red}
\DeclareMathOperator{\Rep}{Rep}
\DeclareMathOperator{\Res}{Res}
\DeclareMathOperator{\sech}{sech}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\Shv}{Shv}
\DeclareMathOperator{\Sht}{Sht}
\DeclareMathOperator{\SL}{SL}
\DeclareMathOperator{\SO}{SO}
\DeclareMathOperator{\Sp}{Sp}
\DeclareMathOperator{\Spa}{Spa}
\DeclareMathOperator{\Spd}{Spd}
\DeclareMathOperator{\spk}{spk}
\DeclareMathOperator{\Spec}{Spec}
\DeclareMathOperator{\Specmax}{Specmax}
\DeclareMathOperator{\Spf}{Spf}
\DeclareMathOperator{\spr}{spr}
\DeclareMathOperator{\spa}{span}
\DeclareMathOperator{\Stab}{Stab}
\DeclareMathOperator{\SU}{SU}
\DeclareMathOperator{\Supp}{Supp}
\DeclareMathOperator{\Syl}{Syl}
\let\Sym\relax
\DeclareMathOperator{\Sym}{Sym}
\DeclareMathOperator{\Tor}{Tor}
\DeclareMathOperator{\Tr}{Tr}
\DeclareMathOperator{\tr}{tr}
\DeclareMathOperator{\vdim}{vdim}
\DeclareMathOperator{\Vect}{Vect}
\DeclareMathOperator{\Vol}{Vol}
\DeclareMathOperator{\vol}{vol}


\DeclareMathOperator{\EH}{EH}
\DeclareMathOperator{\GEH}{GEH}
\DeclareMathOperator{\DHL}{DHL}
\DeclareMathOperator{\Grp}{Grp}
\DeclareMathOperator{\Set}{Set}
\DeclareMathOperator{\Ring}{Ring}
\DeclareMathOperator{\Top}{Top}
\DeclareMathOperator{\Ab}{Ab}
\DeclareMathOperator{\PSh}{PSh}
\DeclareMathOperator{\Sh}{Sh}
\DeclareMathOperator{\Sch}{Sch}
\DeclareMathOperator{\CHaus}{CHaus}
\DeclareMathOperator{\CondSet}{CondSet}
\DeclareMathOperator{\Cond}{Cond}
\DeclareMathOperator{\Cont}{Cont}
\DeclareMathOperator{\qc}{qc}
\DeclareMathOperator{\qs}{qs}
\DeclareMathOperator{\qcqs}{qcqs}
\DeclareMathOperator{\qsep}{qsep}
\DeclareMathOperator{\qSep}{qSep}
\DeclareMathOperator{\Mod}{Mod}
\DeclareMathOperator{\Pfset}{Pfset}
\DeclareMathOperator{\Cof}{Cof}
\DeclareMathOperator{\eq}{eq}
\DeclareMathOperator{\coeq}{coeq}


%%custom symbol fonts


\ifaug 

\DeclareFontFamily{U}{MnSymbolA}{}
\DeclareFontShape{U}{MnSymbolA}{m}{n}{
  <-6> MnSymbolA5
  <6-7> MnSymbolA6
  <7-8> MnSymbolA7
  <8-9> MnSymbolA8
  <9-10> MnSymbolA9
  <10-12> MnSymbolA10
  <12-> MnSymbolA12}{}

\DeclareFontFamily{U}{MnSymbolC}{}
\DeclareFontShape{U}{MnSymbolC}{m}{n}{
  <-6> MnSymbolC5
  <6-7> MnSymbolC6
  <7-8> MnSymbolC7
  <8-9> MnSymbolC8
  <9-10> MnSymbolC9
  <10-12> MnSymbolC10
  <12-> MnSymbolC12}{}

\DeclareFontFamily{U}{MnSymbolD}{}
\DeclareFontShape{U}{MnSymbolD}{m}{n}{
  <-6> MnSymbolD5
  <6-7> MnSymbolD6
  <7-8> MnSymbolD7
  <8-9> MnSymbolD8
  <9-10> MnSymbolD9
  <10-12> MnSymbolD10
  <12-> MnSymbolD12}{}



%I cannot see a way to `\DeclareFontFamily{OMX}{MnSymbolE}{}\n \DeclareFontShape{OMX}{MnSymbolE}{m}{n}[...]\DeclareSymbolFont{largesymbols}{OMX}{MnSymbolE}{m}{n}\n \DeclareMathDelimiter{(}{\mathopen}{largesymbols}{'210}{largesymbols}{'210}[...]` without screwing up every other symbol. It's not obvious to me why this one overwrites the other symbols while the other substitutions do not.

\DeclareSymbolFont{MnSyA}{U}{MnSymbolA}{m}{n}
\DeclareSymbolFont{MnSyC}{U}{MnSymbolC}{m}{n}
\DeclareSymbolFont{MnSyD}{U}{MnSymbolD}{m}{n}



\DeclareMathSymbol{\rightarrow}{\mathrel}{MnSyA}{0}
\DeclareMathSymbol{\to}{\mathrel}{MnSyA}{0}
\DeclareMathSymbol{\leftarrow}{\mathrel}{MnSyA}{2}
\DeclareMathSymbol{\leftrightarrow}{\mathrel}{MnSyA}{16}
\let\updownarrow\relax
\DeclareMathSymbol{\updownarrow}{\mathrel}{MnSyA}{17}
\let\hookrightarrow\relax
\DeclareMathSymbol{\hookrightarrow}{\mathrel}{MnSyA}{48}
\DeclareMathSymbol{\twoheadrightarrow}{\mathrel}{MnSyA}{24}
\DeclareMathSymbol{\rightleftharpoons}{\mathrel}{MnSyA}{88}
\DeclareMathSymbol{\rightrightarrows}{\mathrel}{MnSyA}{144}
\DeclareMathSymbol{\leadsto}{\mathrel}{MnSyA}{160}
\DeclareMathSymbol{\setminus}{\mathrel}{MnSyC}{19}
\DeclareMathSymbol{\cupdot}{\mathbin}{MnSyC}{60}
\DeclareMathSymbol{\triangle}{\mathrel}{MnSyC}{81}
\DeclareMathSymbol{\square}{\mathrel}{MnSyC}{106}
\DeclareMathSymbol{\diamond}{\mathrel}{MnSyC}{108}
\let\lozenge\relax
\DeclareMathSymbol{\lozenge}{\mathrel}{MnSyC}{197}
\DeclareMathSymbol{\ast}{\mathbin}{MnSyC}{135}
\DeclareMathSymbol{\emptyset}{\mathord}{MnSyC}{103}
\DeclareMathSymbol{*}{\mathbin}{MnSyC}{135}
\let\relbar\relax
\DeclareMathSymbol{\relbar}{\mathrel}{MnSyA}{208}
\DeclareMathSymbol{\top}{\mathord}{MnSyC}{151}
\DeclareMathSymbol{\neg}{\mathord}{MnSyC}{32}
\DeclareMathSymbol{\land}{\mathbin}{MnSyC}{44}
\DeclareMathSymbol{\wedge}{\mathbin}{MnSyC}{44}
\DeclareMathSymbol{\lor}{\mathbin}{MnSyC}{45}
\DeclareMathSymbol{\vee}{\mathbin}{MnSyC}{45}
\DeclareMathSymbol{\forall}{\mathord}{MnSyC}{166}
\DeclareMathSymbol{\exists}{\mathord}{MnSyC}{167}
\DeclareMathSymbol{\sim}{\mathrel}{MnSyD}{2}
\DeclareMathSymbol{\in}{\mathrel}{MnSyD}{62}
\DeclareMathSymbol{\ni}{\mathrel}{MnSyD}{63}
\DeclareMathSymbol{\subset}{\mathrel}{MnSyD}{96}
\DeclareMathSymbol{\supset}{\mathrel}{MnSyD}{97}
\DeclareMathSymbol{\subseteq}{\mathrel}{MnSyD}{98}
\DeclareMathSymbol{\supseteq}{\mathrel}{MnSyD}{99}
\DeclareMathSymbol{\subsetneq}{\mathrel}{MnSyD}{248}
\DeclareMathSymbol{\supsetneq}{\mathrel}{MnSyD}{249}
\DeclareMathSymbol{\subsetneqq}{\mathrel}{MnSyD}{250}
\DeclareMathSymbol{\supsetneqq}{\mathrel}{MnSyD}{251}
\let\notin\relax
\DeclareMathSymbol{\notin}{\mathrel}{MnSyD}{182}

%cannot do complement,(,[,etc.


\makeatletter

\def\joinrel{\mathrel{\mkern-3mu}}

\def\leftarrowfill@#1{\m@th\setboxz@h{$#1\relbar$}\ht\z@\z@
  $#1\mathord \leftarrow\mkern-6mu\cleaders%-6mu is how long to the left
  \hbox{$#1\mkern-2mu\copy\z@\mkern-2mu$}\hfill
  \mkern-6mu\box\z@$}%-6mu is how long the arrow extension is
  
\def\rightarrowfill@#1{\m@th\setboxz@h{$#1\relbar$}\ht\z@\z@
  $#1\copy\z@\mkern-6mu\cleaders
  \hbox{$#1\mkern-2mu\box\z@\mkern-2mu$}\hfill
  \mkern-6mu\mathord\rightarrow$}

%ideas: get longleftarrow,relbar (leftrightline) from mnsymbol . . . also need somehow to smash subscript of the varprojlim . . .

\def\underarrow@#1#2#3{%
 \vtop{\ialign{##\crcr$\m@th\hfil#2#3\hfil$\crcr
 \noalign{\nointerlineskip\kern0.5\ex@}#1#2\crcr}}}


\def\underleftarrow{\mathpalette{\underarrow@\leftarrowfill@}}
\def\underrightarrow{\mathpalette{\underarrow@\rightarrowfill@}}


\let\varprojlim\relax
\let\varinjlim\relax
\DeclareMathOperator*{\varprojlim}{\underleftarrow\lim}
\DeclareMathOperator*{\varinjlim}{\underrightarrow\lim}

\makeatother

\fi


%%

\def\tableofcontents{
\section*{Contents}
\newread\tcr
\openin\tcr=\jobname.toc
\loop\unless\ifeof\tcr
\read\tcr to \tableofcontents
\tableofcontents
\repeat
\closein\tcr

\newwrite\tc%can we put this outside the command?
\openout\tc=\jobname.toc
}

\makeatletter

%try \unexpanded instead of \noexpand (\immediate makes the macros expand)

\newcommand\tempsection[1]{
	\section{{#1}}
	\immediate\write\tc{\noindent\hbox to 5em{\hbox{\thesection.}}\noexpand#1\hfill\thepage\par}
}

\newcommand\tempsubsection[1]{
	\subsection{{#1}}
	\immediate\write\tc{\noindent\hbox to 5em{\hbox{\thesubsection.}}\noexpand#1\hfill\thepage\par}
}

%%


\setenumerate[1]{label=\normalfont(\roman*)}
\setenumerate[2]{label=\normalfont(\alph*)}

\setlist[enumerate]{label=\normalfont(\roman*),topsep=0em,itemsep=0em,leftmargin=*}

\setlist[itemize]{label=---,leftmargin=*}%topsep=0em

\ifold
\parskip=0.5\baselineskip\advance\parskip by 0pt plus 2pt
\fi

\catcode`@=11
\let\@afterindentfalse\iftrue
\catcode`@=12


%%ENVIRONMENTS


%esquisse [Esquisse](for proof sketches)
%thm [Theorem]
%theorem [Theorem]
%lemma [Lemma]
%corollary [Corollary]
%proposition [Proposition]
%conj [Conjecture]
%definition [Definition]
%deflem [Definition/Lemma]
%defprop [Definition/Proposition]
%question [Question]
%example [Example]
%examples [Examples]
%convention [Convention]
%exercise [Exercise]
%problem [Problem]
%notation [Notation]
%bnotation [Bad notation]
%remark [Remark]
%warn [Warning]
%ramble [Ramble]
%eproof [Proof](builtin itemize for proper formatting with enumerates and QED symbol)
%\begin{eproof}
% \item [something]
% \item [something]
%\end{eproof}


\let\proof\relax%will redefine the proof environment for style
\let\endproof\relax%"

\newcommand{\defn}[1]{{{\bf #1}}}

\ifplain
                 
  \newtheoremstyle{thm}
    {1em}%space above
    {1em}%space below
    {}
    {0em}%indent amount
    {\sc}
    {.}
    {\newline}
    {\thmname{#1}\thmnote{: #3}}
    %\thmname{#1}\thmnumber{ #2}\thmnote{ (#3)}
    
  \newtheoremstyle{defn}
    {1em}
    {1em}
    {}
    {0em}
    {\sc}
    {.}
    {\newline}
    {\thmname{#1}\thmnote{: #3}}

  \newtheoremstyle{remark}
    {1em}
    {1em}
    {}
    {0em}
    {\sc}
    {.}
    {\newline}
    {\thmname{#1}\thmnote{ --- #3}}

  \newtheoremstyle{proof}
    {1em}
    {1em}
    {}
    {0em}
    {\sc}
    {.}
    {\newline}
    {\thmname{#1}\thmnote{ --- #3}}
 
\else

\ifold

  \newtheoremstyle{thm}
    {0.5\baselineskip}
    {0.5\baselineskip}
    {\it}
    {\parindent}
    {\sc}
    {.}
    {1em}
    {\thmname{#1}\thmnumber{ #2}{\thmnote{ {\rm (#3)}}}}
    %\thmname{#1}\thmnumber{ #2}\thmnote{ (#3)}

  \newtheoremstyle{defn}
    {0.5\baselineskip}
    {0.5\baselineskip}
    {}
    {\parindent}
    {\sc}
    {.}
    {1em}
    {\thmname{#1}\thmnumber{ #2}{\thmnote{ {\rm (#3)}}}}   

  \newtheoremstyle{remark}
    {0.5\baselineskip}
    {0.5\baselineskip}
    {}
    {\parindent}
    {\it}
    {.}
    {1em}
    {\thmname{#1}\thmnumber{ #2}{\thmnote{ {\rm (#3)}}}} 

  \newtheoremstyle{proof}
    {0.5\baselineskip}
    {0.5\baselineskip}
    {}
    {\parindent}
    {\it}
    {.}
    {1em}
    {\thmname{#1}{\thmnote{ {\rm (#3)}}}}

\else
  
  \newtheoremstyle{thm}
    {1em}
    {1em}
    {\ifuprighttheorem\else\slshape\fi}
    {0em}
    {\bf}
    {}
    {1em}
    {\thmname{#1}\thmnumber{ #2.}{\thmnote{ {\normalfont\sc #3.}}}}
    %\thmname{#1}\thmnumber{ #2}\thmnote{ (#3)}

  \newtheoremstyle {defn}
    {1em}
    {1em}
    {}
    {0em}
    {\bf}
    {}
    {1em}
    {\thmname{#1}\thmnumber{ #2.}{\thmnote{ {\normalfont\sc #3.}}}}    

  \newtheoremstyle{remark}
    {1em}
    {1em}
    {}
    {0em}
    {\bf}
    {}
    {1em}
    {\thmname{#1.}{\thmnote{ {\normalfont\sc #3.}}}} 

  \newtheoremstyle{proof}
    {1em}
    {1em}
    {}
    {0em}
    {\bf}
    {}
    {1em}
    {\thmname{#1.}{\thmnote{ {\normalfont\sc #3.}}}}

\fi
     
\fi
               

\theoremstyle{proof}
\newtheorem*{proof}{Proof}
\newtheorem*{pf}{Proof}
\newtheorem*{esquisse}{Esquisse}
\newtheorem*{solution}{Solution}

\theoremstyle{remark}
\newtheorem*{remark}{Remark}
\newtheorem*{ramble}{Ramble}
			
\let\tempendproof=\endproof
\def\endproof{\hfill\mbox{$\square$}\tempendproof}
			
\numberwithin{equation}{section}
\theoremstyle{thm}
\newtheorem{thm}{Theorem}

\ifsections
  \numberwithin{thm}{section}
\fi

\newtheorem{theorem}[thm]{Theorem}
\newtheorem{lemma}[thm]{Lemma}
\newtheorem{corollary}[thm]{Corollary}
\newtheorem{algorithm}[thm]{Algorithm}
\newtheorem{proposition}[thm]{Proposition}
\newtheorem{conj}[thm]{Conjecture}
\newtheorem{deflem}[thm]{Definition/Lemma}
\newtheorem{defprop}[thm]{Definition/Proposition}


\theoremstyle{defn}

\newtheorem{definition}[thm]{Definition}
\newtheorem{question}[thm]{Question}
\newtheorem{example}[thm]{Example}
\newtheorem{examples}[thm]{Examples}
\newtheorem{convention}[thm]{Convention}
\newtheorem{exercise}[thm]{Exercise}
\newtheorem{surprise}[thm]{Surprise}			
\newtheorem{problem}[thm]{Problem}		
\newtheorem{notation}[thm]{Notation}
\newtheorem{bnotation}[thm]{Bad notation}
\newtheorem{warn}[thm]{Warning}


\newenvironment{eproof}{\begin{pf}\text{}\begin{enumerate}}{\hfill$\square$\end{enumerate}\end{pf}}
\newenvironment{iproof}{\begin{pf}\text{}\begin{itemize}}{\hfill$\square$\end{itemize}\end{pf}}


%%title/title page/headers/footers


\ifdefined\ttitle%accepts predefinition of tteacher,tauthor,tterm
  
  \makeatletter
    
    \def\title#1{\gdef\@title{#1}\gdef\THETITLE{#1}}
    
    \renewcommand\maketitle{
      \thispagestyle{empty}{
        \raggedright
        \iftitlesamepage\else\vspace*{\fill}\fi
        \begin{center}
          {\Large\sc \ttitle}\\\vspace*{1em}
          \ifdefined\tteacher
            {\large Based on lectures by \tteacher}\\[0.1em]
          \fi
          \ifdefined\tauthor
            {\normalsize Typeset by \tauthor}\\
          \fi
          {\small Last updated on \today}\\
          \ifdefined\tterm
            \vspace*{1em}
            {\normalsize \tterm}\\
          \fi
          \vspace*{2em}
        \end{center}
        \iftitlesamepage\else\vspace*{\fill}\fi
        \iftitlesamepage\else\newpage\fi
        \ifsections
          \tableofcontents
          \newpage
        \fi
      }
    }
    
  \makeatother


\else
  
  \makeatletter\renewcommand\maketitle{}\makeatother
  
\fi

\makeatletter
  
  \renewcommand{\@seccntformat}[1]{\csname the#1\endcsname.\quad}
  
\makeatother

\makeatletter

  \renewcommand{\section}{\@startsection
    {section}
    {1}%level
    {\z@}%indent 0mm
    {-2\baselineskip}%before skip -3.5ex \@plus -1ex \@minus -.2ex
    {2\baselineskip}%after skip 2.3ex \@plus .2ex
    {\centering\bf}}%do not move second brace to next line
    
\makeatother


\makeatletter

  \renewcommand{\subsection}{\@startsection
    {subsection}
    {2}
    {\z@}
    {-\baselineskip}
    {\baselineskip}
    {\sc}}
  
\makeatother


\makeatletter

  \renewcommand{\subsubsection}{\@startsection
    {subsubsection}
    {3}
    {\z@}
    {-\baselineskip}
    {\baselineskip}
    {}}
  
\makeatother


\makeatletter
%https://tex.stackexchange.com/questions/94853/section-and-subsection-alternating-in-the-header

  \xapptocmd{\@sect}{\csname #1mark\endcsname{#7}}{}{}

\makeatother


\pagestyle{fancy}
\renewcommand{\sectionmark}[1]{\markright{#1}}
\renewcommand{\subsectionmark}[1]{}
\fancyhf{}

\ifams%add ams newif or detect differently
  \renewcommand{\sectionmark}[1]{\markleft{#1}}
\fi

\ifold

\ifdefined\ttitle

\ifdefined\tauthor

\fancyhead[CO]{\small{\MakeUppercase\ttitle}}
\fancyhead[CE]{\small{\MakeUppercase\tauthor}}

\fi

\fi

\else

\ifdefined\ttitle
  \ifsections
    \fancyhead[CE]{\small\sc\ttitle}
    \fancyhead[CO]{\small\sc\nouppercase\rightmark}
  \else
    \fancyhead[C]{\small\sc\ttitle}
  \fi
  
\else
  \fancyhead[C]{\small\sc\nouppercase\rightmark}
\fi

\fi

\fancyhead[LE,RO]{\footnotesize\thepage}

\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

\ifindex%add index newif or detect differently
  \makeindex
  \indexsetup{othercode={\thispagestyle{fancy}}}
\fi
